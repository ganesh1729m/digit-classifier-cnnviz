{% extends "classifier/base.html" %}

{% block title %}Digit Classifier{% endblock %}


{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .drawing-area {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }

  #canvas, #heatmap {
    border: 2px solid black;
    background: white;
  }

  #canvas {
    width: 280px;
    height: 280px;
    cursor: crosshair;
    touch-action: none;
  }

  #heatmap {
    width: 280px;
    height: 280px;
    display: none;
  }

  #prediction-box {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 10px;
    flex-wrap: wrap;
    font-size: 16px;
  }

  .draw-buttons, .action-buttons {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 10px;
    flex-wrap: wrap;
  }

  .draw-buttons button,
  .action-buttons button {
    padding: 10px 16px;
    font-size: 14px;
    cursor: pointer;
  }

  #probChart {
    max-width: 600px;
    margin: 20px auto;
  }

  /* Inline Grad-CAM legend */
  .gradcam-legend {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 10px;
    font-size: 14px;
    flex-wrap: wrap;
  }
  .gradcam-legend span {
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .gradcam-legend .color-box {
    width: 20px;
    height: 20px;
    border: 1px solid #000;
    display: inline-block;
  }
</style>
{% endblock %}

{% block content %}
<h2>Draw a Digit (0‚Äì9)</h2>

<button type="button" class="collapsible">üìò How to Interpret the Results</button>
<div class="content">
  <h3>Understanding Your Results</h3>
  <ul>
    <li><b>üß† Grad-CAM Heatmap:</b> The heatmap shows where the model focused while making its decision.  
      <ul>
        <li><span style="color:red;">Red areas</span> ‚Üí strongest influence.</li>
        <li><span style="color:blue;">Blue areas</span> ‚Üí least influence.</li>
        <li>Use this to check if the model is ‚Äúlooking‚Äù at the correct strokes of your digit.</li>
      </ul>
    </li>
    
    <li><b>üìä Probability Chart:</b> Displays the model‚Äôs confidence (0‚Äì9).  
      <ul>
        <li>The tallest bar = the final prediction.</li>
        <li>Close bars indicate model uncertainty.</li>
      </ul>
    </li>
    
    <li><b>üîç Feature Maps:</b> Each grid image comes from a filter inside the CNN.  
      <ul>
        <li>Early layers ‚Üí detect edges, corners, and basic strokes.</li>
        <li>Deeper layers ‚Üí capture complex digit shapes and patterns.</li>
      </ul>
    </li>

    <li><b>üíæ Save & Report:</b>  
      <ul>
        <li>You can <b>save heatmaps and feature maps</b> for further analysis.</li>
        <li>If a prediction seems wrong, you can <b>report the case</b> for model improvement.</li>
      </ul>
    </li>

    <li><b>üìÇ Dashboard View:</b>  
      <ul>
        <li>All past predictions are stored in your <b>Dashboard</b>.</li>
        <li>You can revisit them, download outputs, or compare multiple results.</li>
      </ul>
    </li>

    <li><b>üí° Tip:</b> If you see repeated mistakes (e.g., confusing ‚Äú3‚Äù and ‚Äú5‚Äù), it‚Äôs a signal the model might need more training on those digits.</li>
  </ul>
</div>

<div class="drawing-area">
  <canvas id="canvas"></canvas>
  <img id="heatmap" alt="Grad-CAM Heatmap" />
</div>

<!-- Grad-CAM Inline Legend -->
<div style="display:flex; flex-direction:column; align-items:center; margin-top:10px;">
  <canvas id="gradcamLegend" width="280" height="20" style="border:1px solid #000;"></canvas>
  <div style="display:flex; justify-content:space-between; width:280px; font-size:12px;">
    <span>Low</span>
    <span>High</span>
  </div>
</div>
<!-- 
<div class="drawing-area">
  <canvas id="canvas"></canvas>
  <img id="heatmap" alt="Grad-CAM Heatmap" />
  <img id="occlusionmap" alt="Occlusion Sensitivity Map" style="display:none; width:280px; height:280px; border:2px solid black;" />
</div>
 -->


<div class="draw-buttons">
  <button id="clear-btn">üßπ Clear</button>
  <button id="predict-btn">üîÆ Predict</button>
</div>

<div id="prediction-box">
  <div>Prediction: <span id="prediction">-</span></div>
  <div>Confidence: <span id="confidence">-</span></div>
</div>

<canvas id="probChart" width="600" height="200"></canvas>

<div class="action-buttons">
  <button id="save-btn" disabled>üíæ Save Prediction</button>
  <button id="report-btn" disabled>‚ö†Ô∏è Report Misclassification</button>
</div>

<div id="feature-maps" style="margin-top:20px; text-align:center;">
  <h3>Feature Maps</h3>
  <div id="conv1-maps" style="display:flex; flex-wrap:wrap; justify-content:center; gap:5px; margin-bottom:10px;"></div>
  <div id="conv2-maps" style="display:flex; flex-wrap:wrap; justify-content:center; gap:5px;"></div>
</div>


{% endblock %}

{% block extra_scripts %}
<script>
const csrftoken = (document.cookie.split('; ').find(row => row.startsWith('csrftoken=')) || '').split('=')[1] || '';

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
ctx.fillStyle = 'white';
ctx.fillRect(0, 0, canvas.width, canvas.height);
ctx.lineWidth = 10;
ctx.lineCap = 'round';
ctx.strokeStyle = 'black';

let drawing = false;
let lastPrediction = null;
let lastCanvasImage = null;
let lastPredictionId = null;
let chart = null;

function pointerPos(e) {
  const rect = canvas.getBoundingClientRect();
  let x = e.clientX ?? e.touches[0].clientX;
  let y = e.clientY ?? e.touches[0].clientY;
  return { x: (x - rect.left) * canvas.width / rect.width, y: (y - rect.top) * canvas.height / rect.height };
}

function startDraw(e) { drawing = true; const p = pointerPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); e.preventDefault(); }
function stopDraw(e) { drawing=false; ctx.beginPath(); e?.preventDefault(); }
function draw(e) { if(!drawing) return; const p = pointerPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(p.x,p.y); e.preventDefault(); }

canvas.addEventListener('mousedown', startDraw);
canvas.addEventListener('mousemove', draw);
window.addEventListener('mouseup', stopDraw);
canvas.addEventListener('touchstart', startDraw, {passive:false});
canvas.addEventListener('touchmove', draw, {passive:false});
window.addEventListener('touchend', stopDraw);

document.getElementById('clear-btn').addEventListener('click', () => {
  ctx.fillStyle='white'; ctx.fillRect(0,0,canvas.width,canvas.height);
  document.getElementById('prediction').innerText='-';
  document.getElementById('confidence').innerText='-';
  document.getElementById('heatmap').style.display='none';
  document.getElementById('save-btn').disabled=true;
  document.getElementById('report-btn').disabled=true;
  if(chart) chart.destroy(); chart=null;
  lastPrediction=lastCanvasImage=lastPredictionId=null;
  document.getElementById('feature-maps').style.display = 'none';
  document.getElementById('occlusionmap').style.display='none';

});

function updateChart(probs){
  const ctxC=document.getElementById('probChart').getContext('2d');
  if(chart) chart.destroy();
  chart=new Chart(ctxC,{
    type:'bar',
    data:{labels:[...Array(10).keys()], datasets:[{label:'Probability', data:probs, backgroundColor:'rgba(54,162,235,0.6)'}]},
    options:{scales:{y:{beginAtZero:true,max:1}}, animation:false}
  });
}

function drawGradcamLegendJET() {
  const legendCanvas = document.getElementById('gradcamLegend');
  const ctx = legendCanvas.getContext('2d');

  const width = legendCanvas.width;
  const height = legendCanvas.height;
  const imageData = ctx.createImageData(width, height);

  // Generate JET colormap
  for (let x = 0; x < width; x++) {
    const t = x / (width - 1); // normalized 0-1

    // JET colormap logic (blue ‚Üí cyan ‚Üí yellow ‚Üí red)
    let r = 0, g = 0, b = 0;
    if (t < 0.35) { b = 1; g = t / 0.35; }             // Blue ‚Üí Cyan
    else if (t < 0.65) { g = 1; b = 1 - (t - 0.35)/0.3; } // Cyan ‚Üí Yellow
    else { r = (t - 0.65)/0.35; g = 1 - r; }           // Yellow ‚Üí Red

    const ir = Math.round(r*255), ig = Math.round(g*255), ib = Math.round(b*255);

    for (let y = 0; y < height; y++) {
      const idx = (y*width + x)*4;
      imageData.data[idx] = ir;
      imageData.data[idx+1] = ig;
      imageData.data[idx+2] = ib;
      imageData.data[idx+3] = 255;
    }
  }

  ctx.putImageData(imageData, 0, 0);
}

// Call once on page load
drawGradcamLegendJET();

document.getElementById('predict-btn').addEventListener('click', async () => {
  try {
    lastCanvasImage=canvas.toDataURL('image/png');
    const form=new FormData(); form.append('image', lastCanvasImage);
    const resp = await fetch("{% url 'predict' %}", {method:'POST', body:form});
    const json = await resp.json();
    if(!json.success){ alert('Prediction failed: '+(json.message||'unknown')); return; }
    lastPrediction=json;
    document.getElementById('prediction').innerText=json.predicted_class;
    document.getElementById('confidence').innerText=(json.confidence*100).toFixed(2)+'%';
    const hm=document.getElementById('heatmap'); hm.src=json.heatmap; hm.style.display='block';
    // const om=document.getElementById('occlusionmap'); 
    // if (json.occlusion) {
    //   om.src = json.occlusion;
    //   om.style.display = 'block';
    // } else {
    //   om.style.display = 'none';
    // }

    document.getElementById('save-btn').disabled=false;
    document.getElementById('report-btn').disabled=false;
    updateChart(json.probabilities);

    // üî• Feature maps rendering here
    const conv1Div = document.getElementById('conv1-maps');
    const conv2Div = document.getElementById('conv2-maps');
    conv1Div.innerHTML = '';
    conv2Div.innerHTML = '';

    if (json.feature_maps) {
      // üëá Show feature maps container again
      document.getElementById('feature-maps').style.display = 'block';

      if (json.feature_maps.conv1) {
        json.feature_maps.conv1.forEach(b64 => {
          const img = document.createElement('img');
          img.src = "data:image/png;base64," + b64;
          img.width = 56; img.height = 56;
          conv1Div.appendChild(img);
        });
      }
      if (json.feature_maps.conv2) {
        json.feature_maps.conv2.forEach(b64 => {
          const img = document.createElement('img');
          img.src = "data:image/png;base64," + b64;
          img.width = 56; img.height = 56;
          conv2Div.appendChild(img);
        });
      }
    }

  } catch(e){ console.error(e); alert('Prediction error: '+e); }
});

document.getElementById('save-btn').addEventListener('click', async () => {
  if(!lastPrediction || !lastCanvasImage){ alert('‚ö†Ô∏è Nothing to save ‚Äî run Predict first.'); return; }
  try {
    const payload={ canvas_image:lastCanvasImage, heatmap_image:lastPrediction.heatmap, predicted_class:lastPrediction.predicted_class, confidence:lastPrediction.confidence, probabilities:lastPrediction.probabilities };
    const resp = await fetch("{% url 'save_prediction' %}", {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken}, body:JSON.stringify(payload)});
    const json = await resp.json();
    if(!json.success){ alert('‚ùå Save failed: '+(json.message||'unknown')); return; }
    lastPredictionId=json.prediction_id;
    alert('‚úÖ '+(json.message||'Saved')+' (id='+lastPredictionId+')');
  } catch(e){ console.error(e); alert('Save error: '+e); }
});

document.getElementById('report-btn').addEventListener('click', async () => {
  if(!lastPrediction && !lastPredictionId){ alert('‚ö†Ô∏è No prediction to report.'); return; }
  const correctLabel=prompt('Enter correct digit (0-9):');
  if(correctLabel===null) return;
  try {
    let payload={reason:`User-corrected label: ${correctLabel}`};
    if(lastPredictionId){ payload.prediction_id=lastPredictionId; } 
    else { payload={...payload, canvas_image:lastCanvasImage, heatmap_image:lastPrediction?.heatmap, predicted_class:lastPrediction?.predicted_class, confidence:lastPrediction?.confidence, correct_label:correctLabel}; }
    const resp=await fetch("{% url 'report_misclassification' %}", {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken}, body:JSON.stringify(payload)});
    const json=await resp.json();
    if(!json.success){ alert('‚ùå Report failed: '+(json.message||'unknown')); return; }
    alert('‚úÖ '+(json.message||'Reported'));
  } catch(e){ console.error(e); alert('Report error: '+e); }
});


</script>
{% endblock %}
